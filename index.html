<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="utf-8">
      <title>San Francisco - Fire!</title>

      <link type="text/css" href="stylesheet.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
      <script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

      <style>
        h1.title, h1.title-loader {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-size: 42px;
            text-align: center;
        }

        h1.pageTitle {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-size: 60px;
            text-align: center;
            opacity: 0;
        }

        h1.sectionHeader {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            font-size: 36px;
            text-align: left;
            opacity: 0;
            margin-left: 10%;
        }

        h2.refs {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: left;
            opacity: 0;
            margin-left: 10%;
        }

        text {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }

        text.barChartTitle {
            font-size: 20px;
        }

        div.tooltip {	
            position: absolute;			
            text-align: center;			
            width: auto;					
            height: auto;					
            padding: 5px;				
            font: 12px sans-serif;		
            background: lightsteelblue;	
            border: 0px;		
            border-radius: 8px;			
            pointer-events: none;	
            z-index: 1002;		
        }

        div.container {
            height: 1000px;
            width: 1250px;

            bottom: 0;
            top: 0;
            left: 0;
            right: 0;

            margin: auto;
        }

        div.mapDiv {
            width: 55%;
            height: 1000px;
            float: left;
        }

        div.chartDiv {
            height: 1000px;
        }

        div.linechart {
            height: 1500px;
            width: auto;

            bottom: 0;
            top: 0;
            left: 0;
            right: 0;

            /* margin: auto; */
        }

        div.references {
            height: auto;
            width: auto;
            
            margin: 25px;
        }

        rect.selection {
            z-index: 1001;
        }

        p.reset {
            height: 20px;
            width: 80px;
            text-align: center;
            border-style: solid;
            border-width: 1px;
            border-color: black;
            cursor: pointer;
        }

        .lineDataIncidents {
            fill: none;
            stroke-width: 0.7;
        }

        .lineDataViolations {
            fill: none;
            stroke-width: 0.7;
        }

        p {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            opacity: 0;
            margin-left: 10%;
            margin-right: 10%;
        }

        svg.lineChart {
            margin-left: 10%;
            margin-right: 10%;
        }

      </style>
  </head>


  <body>
      <a href="explainer.html">Explainer page</a>
      <h1 class="title-loader">
            <i class="fa fa-refresh fa-spin" style="font-size:96px"></i>
      </h1>

      <h1 class="pageTitle">
        San Francisco is on fire!
      </h1>

      <div class="container">
          <p>
            The city of San Francisco is the home of a lot of fiery incidents! From 2005 to 2018 there has been 
            recorded more than 45,000 incidents of fire. Fires happen for a lot of different reasons - cooking fires,
            building fires, vehicle and general outdoor fires are among the first things we think about when thinking about fires.
            And San Francisco are no stranger to these types of fires. </br></br>

            But why does the fires occur? Like any other city; San Francisco has a fire code which establishments, apartment buildings, houses, etc.
            has to live up to. Approved fire emergency plans, ownership of extinguishers and correctly placed, working fire alarms are key to preventing fires.
            The city of SF follow up on these places to check whether they violate the firecode, to ensure a better quality of fire safety. </br></br>
            
            What information can we find about the relationship between violations and incidents in terms of occurences, types and 
            time of day? To answer this we have created the map below. It contains all districts of SF and the violations and incidents in those districts using data from 
            <a href="https://datasf.org/opendata/">datasf.org</a>. </br></br>

            Explore the map and read on!
          </p>
          
          <h1 class="title" style="opacity: 0;">
              San Francisco City
          </h1>
          <p style="text-align: center; font-size: 12px; margin-top: -25px; color: darkgray">
            Hover over circles to see number of incidents/violations in that district. </br>
            Click on a area to view the data in that district. 
          </p>
          <div class="mapDiv"></div>
          <div class="chartDiv">
          </div>

          <div class="linechart">
            <p>
                It seems pretty clear that the majority of fires and violations happen in the northeastern parts of San Francisco.
            </p>
  
            <h1 class="sectionHeader">The history of fires in SF</h1>
            <p>There is data in our line chart</p>
            <p>
                Looking at the line chart below one particular time of year seem to be missing some fires – christmas.
                Every year from the start of the holiday season until a week after christmas eve, there are no datapoints. This is a bit of 
                a flaw in the data as there of course are fires during that period. 
                Actually, according to the National Fire Protection Association (NFPA) 
                the christmas season causes an average of ~1100 building fires and dozens of civilian injuries and deaths every year 
                across the US, because of christmas trees and christmas decoration<sup>1</sup>.
            </p>
            <p>
                The end of the month of October is Halloween in the US and is celebrated across the country. Also during this holiday we can find 
                spikes in the number of fire incidents, especially in the years 2013, 2014 and 2016 we can tell that there is considerably more fires
                than in the months preceding October. </br>
                The NFPA reports of an average of ~860 home structure fires per year from 2009-2013 across the US, as well as 40+ civilian injuries
                and millions in property damage<sup>2</sup>. </br>
                Something quite ironic about this stat is that October is the official Fire Prevention Month in the US<sup>3</sup>.
            </p>
            <p>
                The 4th of July is also widely celebrated in the US. The day celebrates the independence of the United States from the british, and
                is usually celebrated with a lot of fireworks. </br>
                Again, using some zoom and looking at the chart we can clearly see that on the 4th of July every year there is a peak in the number of fires
                with the biggest peak in 2017.
            </p>
            <p>
                For now enough about fires. </br></br>
                When looking at the chart the first thing that pops out is the huge spikes in number of violations, which has some interesting patterns.
                The first pattern is the spikes happening about every 5 years around christmas/new years, marked with circles on the chart.
                These spikes occur because of the policy enforced by the San Francisco Fire Department (SFFD), whom conducts inspections
                on weekly, monthly, annual and semi-annual basis depending on the inspection type. Every fifth year there are certificates
                permits and equipment certification that expires<sup>4</sup> and this is why there are spikes like these.
            </p>
            <p>
                The second pattern we can observe is quite recent – mid 2016 to now. In 2015 a new version of the International Fire Code (IFC) was released with
                significant changes and in July 2016 the state of California updated their Fire Code with adoptions from IFC 2015.
                This brought major changes in standards regard number of exits, doors, gates and turnstiles, sprinkler systems, fire alarms, etc.<sup>5</sup>
            </p>

           </div>

           <div class="references">
               <h2 class="refs">References</h3>
               <p>
                   <sup>1</sup> <a href="https://www.nfpa.org/News-and-Research/Fire-statistics-and-reports/Fire-statistics/Fire-causes/Holiday/Christmas-tree-and-holiday-lights">https://www.nfpa.org/News-and-Research/Fire-statistics-and-reports/Fire-statistics/Fire-causes/Holiday/Christmas-tree-and-holiday-lights</a>
               </p>
               <p>
                   <sup>2</sup> <a href="https://www.nfpa.org/Public-Education/By-topic/Seasonal-fires/Halloween-safety">https://www.nfpa.org/Public-Education/By-topic/Seasonal-fires/Halloween-safety</a>
               </p>
               <p>
                   <sup>3</sup> <a href="https://www.fema.gov/news-release/2006/10/16/october-national-fire-prevention-month">https://www.fema.gov/news-release/2006/10/16/october-national-fire-prevention-month</a>
               </p>
               <p>
                   <sup>4</sup> <a href="https://sf-fire.org/inspections">https://sf-fire.org/inspections</a>
               </p>
               <p>
                   <sup>5</sup> <a href="https://up.codes/viewer/california/ca-fire-code-2016">https://up.codes/viewer/california/ca-fire-code-2016</a>
               </p>
           </div>
      </div>

      





    <script>

        function removeLoader() {
            d3.select("h1.title-loader").remove();
        }

        function showTitleAndText() {
            d3.selectAll("h1").style("opacity", 1);
            d3.selectAll("h2").style("opacity", 1);
            d3.selectAll("p").style("opacity", 1);

            d3.select("div.container")
                    .attr("height", h);
        }

        var margin = {top: 20, right: 20, bottom: 30, left: 50}
        var w = 1000 - margin.left - margin.right;
        var h = 700 - margin.top - margin.bottom;
        var padding = 1;
        var wBar = 500 - margin.left - margin.right;
        var hBar = 200 - margin.top - margin.bottom;
                            
        var hoursLabels = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];
        var violationTypes = [];
        var fireTypes = [];

        // Reset button
        d3.select("div.mapDiv")
            .append("p")
            .attr("class", "reset")
            .text("Reset map")
            .on("click", function() {
                resetMap();
            });

        var svg = d3.select("div.mapDiv")
                    .append("svg")
                    .attr("width", "auto")
                    .attr("height", h)
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var svgHourBar = d3.select("div.chartDiv")
                            .append("svg")
                            .attr("width", w/2 + 50)
                            .attr("height", hBar*4 + 200);

        var svgLineChart = d3.select("div.linechart")
                            .append("svg")
                            .attr("class", "lineChart")
                            .attr("width", w)
                            .attr("height", hBar + 400);

        var div = d3.select("body")
                    .append("div")	
                    .attr("class", "tooltip")				
                    .style("opacity", 0);

        // parse the date / time
        var parseTime = d3.timeParse("%m/%d/%Y");

        var projection, path, mapCenter, mapScale, mapOffset, brush, circles;
        var zoomMultiplier = 3;
        var circleRadius = 1.5;

        var districtDict = {}; // Key: District name, Value: CSV data
        var circleDict = {}; // Key: District name, Value: <circle> elements
        var coords;

        var yearLimit = 2000;

        d3.csv("JustFires_New.csv", function(data) {
            coords = [];

            var count = 0;
            data.forEach(d => {

                var date = d["Incident Date"]
                var year = +date.substring(date.length - 4, date.length)
                if (year >= yearLimit) {
                    let dataRow = {
                        'lon': +(d.Longitudes.slice(0,-1)),
                        'lat': +d.Latitudes,
                        'hour': +d.Hour - 1,
                        'date': convertDate(d["Incident Date"]),
                        'district': d["Neighborhood  District"],
                        'index': d.Index,
                        'fireType': d["Primary Situation"],
                        'desc': d["Primary Situation Description"],
                        'type': 'incident'
                    };
                    coords.push(dataRow);

                    var arr = (districtDict[dataRow.district] == null) ? [] : districtDict[dataRow.district];
                    arr.push(dataRow);
                    districtDict[dataRow.district] = arr;

                    count++;
                } 
            });
            
            count = 0;
            d3.csv("New_Violations.csv", function(data) {
                data.forEach(d => {
                    var date = d["Violation Date"]
                    var year = +date.substring(date.length - 4, date.length)

                    if(year >= yearLimit) {
                        let dataRow = {
                            'lon': +d.Longitudes,
                            'lat': +d.Latitudes,
                            'desc': d["Violation Item Description"],
                            'date': convertDate(d["Violation Date"]),
                            'district': d["Neighborhood District"],
                            'violation': d["Violation Item"],
                            'index': d.Index,
                            'type': 'violation'
                        };
                        coords.push(dataRow);

                        var arr = (districtDict[dataRow.district] == null) ? [] : districtDict[dataRow.district];
                        arr.push(dataRow);
                        districtDict[dataRow.district] = arr;
                        
                        count++;
                    }
                })

                d3.json("san-francisco.geojson", function(json) {
                    //createBrush();
                    createMap(json);
                    plotIncidents(coords);
                    createFireByHourBarChart(coords);
                    createFireTypeBarChart(coords);
                    createViolationTypeBarChart(coords);
                    createLineChart(coords);

                    removeLoader();
                    showTitleAndText();
                });
            })

            
        })

        function convertDate(dateString) {
            var date = new Date(dateString);
            return date.getDate() + "/" + date.getMonth() + "/" + date.getFullYear();
        }

        function convertToDates(dateString) {
            var newDatesString = ""
            var split = dateString.split('/');
            var day, month;
            if(split[0].length < 2) {
                day = "0" + split[0]
            } else {
                day = split[0]
            }
            if(split[1].length < 2) {
                if(split[1] == '9') {
                    month = '10';
                } else {
                    month = "0" + (parseInt(split[1])+ 1)
                }
            } else {
                month = split[1]
            }
            var returnDate = month + "/" + day + "/" + split[2];
            return returnDate;
        }

        var isBrushing = false;
        function createBrush() {
            brush = d3.brush()
                    .on("start", function() {
                        isBrushing = true;

                        d3.select("p.reset")
                            .style("opacity",1);
                        
                        d3.select("rect.selection")
                            .style("opacity", 1);

                        d3.selectAll("path.map")
                            .style("pointer-events", "none");

                        d3.selectAll("circle")
                            .style("pointer-events", "none");
                    })
                    .on("brush", brushed);
        
            svg.append("g")
                .attr("class", "brush")
                .call(brush)
                .selectAll("rect")
                .attr("height", h);

            d3.select("rect.overlay")
                .on("click", function() {
                    d3.selectAll("path.map")
                        .style("pointer-events", "auto");

                    d3.selectAll("circle")
                        .style("pointer-events", "auto");
                })
        }

        var mapOffSetX = 10;
        function createMap(json) {

            // https://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object
            var width  = w-200;
            var height = 600;

            var center = d3.geoCentroid(json)
            mapCenter = center;

            var scale  = 150;
            var offset = [(w/2) + mapOffSetX, h/3];

            projection = d3.geoMercator()
                            .center(center)
                            .translate(offset)
                            .scale(scale);

            // create the path
            path = d3.geoPath().projection(projection);

            // using the path determine the bounds of the current map and use 
            // these to determine better values for the scale and translation
            var bounds  = path.bounds(json);
            var hscale  = scale*width  / (bounds[1][0] - bounds[0][0]);
            var vscale  = scale*height / (bounds[1][1] - bounds[0][1]);
            var scale   = (hscale < vscale) ? hscale : vscale;
            var offset  = [width - (bounds[0][0] + bounds[1][0])/2,
                            height - (bounds[0][1] + bounds[1][1])/2];

            mapOffset = offset;

            // new projection
            projection = d3.geoMercator()
                            .center(center)
                            .scale(scale)
                            .translate(offset);

            path = path.projection(projection);

            mapScale = scale;
            var zoomScale = scale * zoomMultiplier;

            //Bind data and create one path per GeoJSON 
            svg.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("class", "map")
                .attr("d", path)
                .on("mouseover", function(d) {
                    d3.select(this)
                        .style("fill", "lightgrey");

                    // Tooltip
                    div.transition()		
                        .duration(200)		
                        .style("opacity", .9);

                    div.html(d.properties.name)	
                        .style("left", (d3.event.pageX) + "px")		
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(e) {
                    d3.select(this)
                        .style("fill", "transparent");

                    div.transition()		
                        .duration(500)		
                        .style("opacity", 0);
                })
                .on("click", function(d) {
                    let districtName = d.properties.name;
                    console.log("Clicked " + districtName)
                    
                    projection = d3.geoMercator()
                                    .center(d3.geoCentroid(d))
                                    .scale(zoomScale)
                                    .translate([mapOffset[0] + 80, mapOffset[1]]);

                    path = path.projection(projection);

                    // Remove brush
                    svg.select("rect.overlay")
                        .attr("height", 0);

                    svg.select("rect.selection")
                        .attr("height", 1)
                        .attr("width", 1)
                        .attr("opacity",0);

                    // Zoom into map area
                    svg.selectAll("path.map")
                        .transition()
                        .duration(500)
                        .attr("d", path);

                    createBrush();
                    // Show reset button
                    d3.select("p.reset")
                        .transition()
                        .duration(500)
                        .style("opacity",1);

                    // Update title label
                    d3.selectAll("text.barChartTitle")
                        .text(districtName);


                    d3.selectAll("circle.point").remove();

                    // Update hour chart with fires from this district
                    var districtData = districtDict[districtName];
                    setTimeout(function() {
                        plotCirclesInDistrict(districtData, districtName);
                    }, 500)
                    

                    updateHourBarChartValues(districtData);
                    updateViolationTypeBarChartValues(districtData);
                    updateFireTypeBarChartValues(districtData);
                    updateLineChartValues(districtData)

                    // Move circles correspondly
                    d3.selectAll("circle.blob").style("opacity", 0);

                    // Hide color scale legend
                    d3.select("g.colorScale1").style("opacity",0);
                    d3.select("g.colorScale2").style("opacity",0);
                })
                .style("z-index", 1000)
                .style("stroke-width", "1px")
                .style("stroke", "black")
                .style("pointer-events", function() {
                    if (isBrushing) return "none";
                    if (!isBrushing) return "auto";
                })
                .style("fill", "transparent");
        }

        function resetMap() {
            projection = d3.geoMercator()
                            .center(mapCenter)
                            .scale(mapScale)
                            .translate(mapOffset);

            // Reset brush
            d3.selectAll("path.map")
                .style("pointer-events", "auto");
            d3.selectAll("circle")
                .style("pointer-events", "auto");
            svg.select("g.brush").remove();
            svg.select("rect.selection")
                .attr("height", 1)
                .attr("width", 1)
                .attr("opacity",0);

            path = path.projection(projection);

            svg.selectAll("path.map")
                .transition()
                .duration(500)
                .attr("d", path);

            // Update titles
            d3.selectAll("text.barChartTitle")
                .text("All districts");

            // Update hourChart with all data
            d3.selectAll("circle.point").remove();
            circles.remove();

            setTimeout(function() {
                d3.selectAll("circle.blob").style("opacity", 1);
                d3.select("g.colorScale1").style("opacity", 1);
                d3.select("g.colorScale2").style("opacity", 1);
            }, 500)

            updateHourBarChartValues(coords);
            updateViolationTypeBarChartValues(coords);
            updateFireTypeBarChartValues(coords);
            updateLineChartValues(coords);
        }

        var blobDict = {
            'Mission': {
                'radius': 10,
                'x': 552.9243439756101,
                'y': 362.15352721943054,
                'x1': 576.746798200882,
                'y1': 362.3567922397924
            },
            'Pacific Heights': {
                'radius': 10,
                'x': 477.3845246366691,
                'y': 208.3975285938359,
                'x1': 501.56092184910085,
                'y1': 206.6742995265813
            },
            'Tenderloin': {
                'radius': 10,
                'x': 555.0667100171559,
                'y': 255.0023655188852,
                'x1': 575.887484624167,
                'y1': 242.72138958488358
            },
            'Nob Hill': {
                'radius': 10,
                'x': 548.9240167323733,
                'y': 208.87669966134126,
                'x1': 571.1601522178971,
                'y1': 206.26822700491175
            },
            'Sunset/Parkside': {
                'radius': 10,
                'x': 257.3751178914099,
                'y': 385.7336807681131,
                'x1': 283.8628058375907,
                'y1': 384.8928169288556
            },
            'Potrero Hill': {
                'radius': 10,
                'x': 631.1932695200667,
                'y': 371.96383635737584,
                'x1': 654.3190806755447,
                'y1': 371.1030683515419
            },
            'Lakeshore': {
                'radius': 10,
                'x': 272.77646512002684,
                'y': 549.5548206226085,
                'x1': 297.2896143242251,
                'y1': 549.3441995754838
            },
            'Western Addition': {
                'radius': 10,
                'x': 481.18319553887704,
                'y': 259.67771908509894,
                'x1': 505.02554583357414,
                'y1': 258.74759477822226
            },
            'Noe Valley': {
                'radius': 10,
                'x': 488.7308349570376,
                'y': 419.64641977101564,
                'x1': 512.586394337588,
                'y1': 419.3963443108951
            },
            'Bernal Heights': {
                'radius': 10,
                'x': 548.0952149315272,
                'y': 457.66689662024146,
                'x1': 573.2975660310476,
                'y1': 458.3056077232759
            },
            'Excelsior': {
                'radius': 10,
                'x': 522.8434609692777,
                'y': 529.9515144467296,
                'x1': 549.9789195510093,
                'y1': 529.9866640266846
            },
            'Financial District/South Beach': {
                'radius': 10,
                'x': 617.529293951171,
                'y': 226.38995981987682,
                'x1': 639.3129240432172,
                'y1': 214.1826621844375
            },
            'South of Market': {
                'radius': 10,
                'x': 592.2878074470791,
                'y': 290.55956019158475,
                'x1': 617.5730745836627,
                'y1': 290.0875084688887
            },
            'Inner Sunset': {
                'radius': 10,
                'x': 366.90834727865877,
                'y': 368.0633241602045,
                'x1': 389.8062683591852,
                'y1': 368.2756845986587
            },
            'Glen Park': {
                'radius': 8,
                'x': 493.3941727030324,
                'y': 467.3242780638393,
                'x1': 514.1412660642527,
                'y1': 467.0751808224595
            },
            'Russian Hill': {
                'radius': 10,
                'x': 542.8136017845827,
                'y': 173.52868246476282,
                'x1': 564.8329225390335,
                'y1': 173.35235743693192
            },
            'Ocean View': {
                'radius': 10,
                'x': 378.4472593579558,
                'y': 568.7524658470065,
                'x1': 402.00672980828676,
                'y1': 568.3913497664325
            },
            'Bayview Hunters Point': {
                'radius': 10,
                'x': 639.7083340018289,
                'y': 483.4944607182697,
                'x1': 665.4876638739952,
                'y1': 483.62870796440984
            },
            'Marina': {
                'radius': 10,
                'x': 473.97870453167707,
                'y': 168.94872360429144,
                'x1': 496.59066715301014,
                'y1': 167.5563735141477
            },
            'Inner Richmond': {
                'radius': 10,
                'x': 361.50608354987344,
                'y': 268.6242417470494,
                'x1': 384.55481148837134,
                'y1': 268.7920845876797
            },
            'Chinatown': {
                'radius': 6,
                'x': 592.567902058945,
                'y': 192.4391834687267,
                'x1': 595.0484102975461,
                'y1': 206.42277426304645
            },
            'North Beach': {
                'radius': 10,
                'x': 584.1375016223174,
                'y': 152.01857685443247,
                'x1': 602.6291692794766,
                'y1': 162.97294594298
            },
            'Castro/Upper Market': {
                'radius': 10,
                'x': 473.28621425741585,
                'y': 351.48092473542783,
                'x1': 498.12845925957663,
                'y1': 351.9752062645275
            },
            'West of Twin Peaks': {
                'radius': 10,
                'x': 384.7061765997787,
                'y': 473.40920501129585,
                'x1': 408.96632161474554,
                'y1': 472.839150157175
            },
            'Treasure Island': {
                'radius': 10,
                'x': 723.7942744137254,
                'y': 48.18678537834785,
                'x1': 736.5556558326934,
                'y1': 71.18878857805976
            },
            'Outer Mission': {
                'radius': 10,
                'x': 447.6041791625903,
                'y': 534.1982278995274,
                'x1': 472.4741389808478,
                'y1': 533.5098581422644
            },
            'Presidio': {
                'radius': 10,
                'x': 364.3313983961707,
                'y': 186.0295859327016,
                'x1': 389.3313983961707,
                'y1': 186.0295859327016
            },
            'Presidio Heights': {
                'radius': 9,
                'x': 409.64876784122316,
                'y': 237.48725542234024,
                'x1': 431.9033932235907,
                'y1': 235.15074485653895
            },
            'Outer Richmond': {
                'radius': 10,
                'x': 257.6012087520794,
                'y': 281.1481836050516,
                'x1': 281.95227121026255,
                'y1': 280.5307195520436
            },
            'Golden Gate Park': {
                'radius': 10,
                'x': 289.7807789108483,
                'y': 320.5793662412616,
                'x1': 315.3522542458959,
                'y1': 320.2633309325902
            },
            'Twin Peaks': {
                'radius': 10,
                'x': 421.48287230124697,
                'y': 405.604835337901,
                'x1': 442.81744288658956,
                'y1': 405.123688059306
            },
            'Visitacion Valley': {
                'radius': 10,
                'x': 558.3742838432663,
                'y': 584.1143097104505,
                'x1': 582.2334912163205,
                'y1': 583.8339213161962
            },
            'Haight Ashbury': {
                'radius': 10,
                'x': 437.804881326796,
                'y': 315.35203061965876,
                'x1': 460.95335199293913,
                'y1': 314.6897799776343
            },
            'Seacliff': {
                'radius': 10,
                'x': 234.23334182507824,
                'y': 243.9108217509347,
                'x1': 259.23334182507824,
                'y1': 243.9108217509347
            }
        }

        function plotIncidents(coords) {
            let districtNames = Object.keys(districtDict);

            plotColorScales();

            // Fjerner district med tomt navn
            var index = districtNames.indexOf("");
            if (index > -1) {
                districtNames.splice(index, 1);
            }

            var incMaxLength = 0;
            var vioMaxLength = 0;
            districtNames.forEach(name => {
                var vioCount = 0;
                var incCount = 0;

                var data = districtDict[name]

                data.forEach(d => {
                    if (d.type == 'incident') incCount++;
                    if (d.type == 'violation') vioCount++;
                })

                if (incMaxLength < incCount) {
                    incMaxLength = incCount;
                }

                if (vioMaxLength < vioCount) {
                    vioMaxLength = vioCount;
                }
            })

            districtNames.forEach(name => {
                let blob = blobDict[name]
                data = districtDict[name]

                var incLons = 0, vioLons = 0;
                var incLats = 0, vioLats = 0;
                var incCount = 0, vioCount = 0;

                data.forEach(dd => {
                    if (dd.type == 'incident') {
                        incLons += dd.lon
                        incLats += dd.lat
                        incCount++;
                    } else if (dd.type == 'violation') {
                        vioLons += dd.lon;
                        vioLats += dd.lat;
                        vioCount++;
                    }
                })

                // if (blob == undefined) {
                //     blob = {
                //         'radius': 10,
                //         'x': 0,
                //         'y': 0,
                //         'x1': 0,
                //         'y1': 0,
                //     }
                // }

                var xx = incLons/incCount;
                var yy = incLats/incCount;

                var xx1 = vioLons/vioCount;
                var yy1 = vioLats/vioCount;

                var x = projection([xx, yy])[0];
                var y = projection([xx, yy])[1];

                var incColorScale = d3.scaleLinear()
                                        .domain([0,0.5,1])
                                        .range(["orange","darkorange","red"]);

                var vioColorScale = d3.scaleLinear()
                                        .domain([0,0.5,1])
                                        .range(["khaki", "darkkhaki", "green"]);

                var incColorFraction = incCount / incMaxLength;
                var vioColorFraction = vioCount / vioMaxLength;

                var extraOffset = 210;

                svg.append("circle")
                    .attr("class", "blob")
                    .attr("cx", blob.x - extraOffset)
                    .attr("cy", blob.y)
                    // .attr("cx", blob.x)
                    // .attr("cy", blob.y)
                    // .attr("r", Math.sqrt(data.length)/5)
                    .attr("r", blob.radius)
                    .style("opacity", 1)
                    .style("shape-rendering", "cripEdges")
                    .attr("fill", function() { 
                        return incColorScale(incColorFraction)
                    })
                    .on("mouseover", function(d) {
                        // Tooltip
                        if (d3.select(this).style("opacity") == 1) {
                            div.transition()		
                                .duration(200)		
                                .style("opacity", .9);

                            div.html(name + "</br>Number of incidents: " + incCount)	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY - 28) + "px");
                        }
                        
                    })
                    .on("mouseout", function(e) {
                        if (d3.select(this).style("opacity") > 0.5) {
                            div.transition()		
                                .duration(500)		
                                .style("opacity", 0);
                        }
                    })
                                
                var x1 = projection([xx1, yy1])[0];
                var y1 = projection([xx1, yy1])[1];

                x1 = (x1) ? x1 : x + 15;
                y1 = (y1) ? y1 : y;

                // console.log('\'' + name + '\': {\n' + '\t\'radius\': ' + blob.radius + 
                // ',\n\t\'x\': ' + (x + blob.x) + 
                // ',\n\t\'y\': ' + (y+blob.y) +
                // ',\n\t\'x1\': ' + (x1+blob.x1) + 
                // ',\n\t\'y1\': ' + (y1+blob.y1) + 
                // '\n},'
                // )

                svg.append("circle")
                    .attr("class", "blob")
                    // .attr("cx", blob.x1)
                    // .attr("cy", blob.y1)
                    .attr("cx", blob.x1 - extraOffset)
                    .attr("cy", blob.y1)
                    .attr("r", blob.radius)
                    .attr("fill", vioColorScale(vioColorFraction))
                    .style("opacity", 1)
                    .on("mouseover", function(d) {
                        // Tooltip
                        if (d3.select(this).style("opacity") == 1) {
                            div.transition()		
                                .duration(200)		
                                .style("opacity", .9);

                            div.html(name + "</br>Number of violations: " + vioCount)	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY - 28) + "px");
                        }
                        
                    })
                    .on("mouseout", function(e) {
                        if (d3.select(this).style("opacity") > 0.5) {
                            div.transition()		
                                .duration(500)		
                                .style("opacity", 0);
                        }
                    });
            })

            
        }

        function plotColorScales() {
            var incColorScale = d3.scaleLinear()
                                    .domain([0,0.5,1])
                                    .range(["orange","darkorange", "red"]);

            var vioColorScale = d3.scaleLinear()
                                    .domain([0,0.5,1])
                                    .range(["khaki", "darkkhaki", "green"]);
            var data = [];
            for (let i = 0.05; i <= 1; i += 0.05) {
                data.push(i);
            }

            // First color scale
            svg.append("g")
                .attr("class", "colorScale1")
                .selectAll("scale")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) {
                    return -30 + 150 * d;
                })
                .attr("y", 5)
                .attr("width", 10)
                .attr("height", 15)
                .attr("fill", function(d) {
                    return incColorScale(d);
                })

            // Title label
            d3.select("g.colorScale1")
                .append("text")
                .style("font-size", "17px")
                .attr("x", -20)
                .attr("y", 0)
                .text("Fire incidents");

            // Min label
            d3.select("g.colorScale1")
                .append("text")
                .style("font-size", "12px")
                .attr("x", -20)
                .attr("y", 30 + 15/2)
                .text("Min");

            // Max label
            d3.select("g.colorScale1")
                .append("text")
                .style("font-size", "12px")
                .attr("x", 100)
                .attr("y", 30 + 15/2)
                .text("Max");


            // Other color scale
            svg.append("g")
                .attr("class", "colorScale2")
                .selectAll("scale2")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", function(d) {
                    return -30 + 150 * d;
                })
                .attr("y", 70)
                .attr("width", 10)
                .attr("height", 15)
                .attr("fill", function(d) {
                    return vioColorScale(d);
                })

            // Title label
            d3.select("g.colorScale2")
                .append("text")
                .style("font-size", "17px")
                .attr("x", -20)
                .attr("y", 65)
                .text("Violations");

            // Min label
            d3.select("g.colorScale2")
                .append("text")
                .style("font-size", "12px")
                .attr("x", -20)
                .attr("y", 95 + 15/2)
                .text("Min");

            // Max label
            d3.select("g.colorScale2")
                .append("text")
                .style("font-size", "12px")
                .attr("x", 100)
                .attr("y", 95 + 15/2)
                .text("Max");
        }

        function plotCirclesInDistrict(districtData, districtName) {
            let districtClass = "district" + districtName.replace(/\s/g, '').replace(/\//g, '');
            circles = svg.append("g")
                                .attr("class", districtClass)
                                .attr("opacity",1)
                                .selectAll(".point")
                                .data(districtData)
                                .enter()
                                .append("circle")
                                .attr("class", "point")
                                .attr("cx", function(d) {
                                    return projection([d.lon, d.lat])[0];
                                })
                                .attr("cy", function(d) {
                                    return projection([d.lon, d.lat])[1];
                                })
                                .attr("r", circleRadius*zoomMultiplier)
                                .attr("fill", function(d) {
                                    if(d.type == 'violation') {
                                        return "orange";
                                    } else return "red";
                                })
                                .attr("name", "hidden")
                                .on("mouseover", function(d) {
                                    // Tooltip
                                    if (d3.select("g." + districtClass).attr("opacity") == 1) {
                                        div.transition()		
                                            .duration(200)		
                                            .style("opacity", .9);
                                        
                                        var desc;
                                        if (d.type == 'violation') {
                                            desc = "<b>Violation Description:</b></br> " + d.desc
                                        } else {
                                            desc = "<b>Incident Description:</b></br> " + d.desc
                                        }

                                        div.html("<b>Date:</b> " + d.date + "</br></br>" + desc)	
                                            .style("left", (d3.event.pageX) + "px")		
                                            .style("top", (d3.event.pageY - 28) + "px");
                                        
                                    }
                                })
                                .on("mouseout", function(e) {
                                    div.transition()		
                                        .duration(500)		
                                        .style("opacity", 0);
                                })
        }
    
        var yScaleBar, xScaleBar;
        const yPaddingForTitle = 30; // To make room for title
        const extraPadding = 100;

        function createFireByHourBarChart(brushedData) {
            var tempHourData = [];
            for(var i = 0; i < brushedData.length; i++) {
                if(brushedData[i].type == 'incident') {
                    tempHourData.push(brushedData[i].hour);
                }
            }
            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempHourData);

            var ascending = function (a, b) {
                return a.key - b.key
            }

            var sortData = filteredData.sort(ascending);

            yScaleBar = d3.scaleLinear()
                    .domain([0, d3.max(sortData, function(d) {
                        return d.values.length;
                    } )])
                    .rangeRound([hBar,0]);

            xScaleBar = d3.scaleBand()
                        .rangeRound([0,wBar])
                        .padding(0,1)
                        .domain(sortData.map(function(d,i) {
                            return +d.key;
                        }));
            
            //Create X axis
            svgHourBar.append("g")
                .attr("class", "axis-x")
                .attr("transform", "translate(" + margin.left + "," + (hBar+margin.top+yPaddingForTitle) + ")")
                .call(d3.axisBottom(xScaleBar));
            
            //Create Y axis
            svgHourBar.append("g")
                .attr("class", "axis-y")
                .attr("transform", "translate(" + margin.left + "," + (margin.top+yPaddingForTitle) + ")")
                .call(d3.axisLeft(yScaleBar));

            // Title label
            svgHourBar.append("text")
                        .attr("class", "barChartTitle")
                        .attr("x", 0 + wBar/2 + 15)
                        .attr("y", 10)
                        .attr("dy", "1em")
                        .text("All districts");

            // X-Label
            svgHourBar.append("text")
                    .attr("class", "legendText")
                    .attr("transform",
                            "translate(" + ((wBar/2)+margin.left/2) + "," + 
                                        (hBar+35+margin.top+yPaddingForTitle) + ")")
                    .text("Hour of day");

            // Y-Label
            svgHourBar.append("text")
                .attr("class", "legendText")
                .attr("transform", "rotate(-90)")
                .attr("y", 0)
                .attr("x", 0 - (hBar / 2) - 70 - yPaddingForTitle)
                .attr("dy", "1em")
                .text("# of fire incidents"); 


            bars = svgHourBar.append("g")
                    .selectAll("rect1")
                    .data(sortData)
                    .enter()
                    .append("rect")
                    .attr("class", "selData")
                    .attr("transform", "translate(" + margin.left + ","+ margin.top +")")
                    .attr("x", function(d,i) {
                        return xScaleBar(+d.key);
                    })
                    .attr("y", function(d) {                        
                        return yScaleBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width", xScaleBar.bandwidth()-1)
                    .attr("height", function(d){
                        return hBar-yScaleBar(d.values.length);
                    })
                    .attr("fill", "crimson")
                    .on("mouseover", function(d){
                        d3.select(this)
                            .attr("fill","red");

                        // Tooltip
                        div.transition()		
                            .duration(200)		
                            .style("opacity", .9);

                        div.html(d.values.length)	
                            .style("left", (d3.event.pageX) + "px")		
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        d3.select(this)
                            .attr("fill", "crimson");

                        div.transition()		
                            .duration(500)		
                            .style("opacity", 0);
                    });
        }

        var yScaleViolationBar, xScaleViolationBar;
        var yDistanceFromHourChart = 250;
        var xDistanceFromHourChart = 550;

        var explainerTexts = {
            'REC': "Reviews and certification of records such as emergency plans,</br> test and maintenance documentation, fire drills, etc.",
            'SPR': "Obstruction of sprinklers and failure of maintenance, service,</br> certifications and replacement/installation of parts.",
            'ALR': "Failure of alarm system maintenance",
            'EXT': "Extinguisher requiring service, maintenance or not present.",
            'DOR': "Violation regarding blocking doors, latches, chutes and self-closers.",
            'EXI': "Blocked exits, fire escapes.",
            'STO': "Storage - misplaced combustibles, gas and eletric meters, ceiling clearance.",
            'ELE': "Electrical violations - extension cords, hazards, workspace clearance, etc.",
            'ILL': "Illumination - repair of lighting, missing exit signs.",
            'SIG': "Maintenance/Missing signs - address numbers, evacuation plans.",
            'PER': "Missing fire permit.",
            'SFC': "Breach of San Fransisco Fire Code.",
            'PEN': "Violations regard walls, ceilings, chutes and fire ratings.",
            'COM': "Fire command center features",
            'KEY': "Keys provided by fire marshall. Removed lock boxes.",
            'HAZ': "Hazards - misplaced gas cylinders and flammable liquids.</br> Missing identification signs.",
            'STD': "Standpipes - obstructions, maintenance, missing parts.",
            '999': "Other violations",
        }

        function createViolationTypeBarChart(data) {
            violationTypes = Object.keys(explainerTexts);

            var tempData = [];
            for(var i = 0; i < data.length; i++) {
                if(data[i].type == 'violation') {
                    tempData.push(data[i].violation);
                }
            }

            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempData);

            var descending = function (a, b) {
                return b.values.length - a.values.length
            }

            var sortData = filteredData.sort(descending);

            yScaleViolationBar = d3.scaleLinear()
                    .domain([0, d3.max(sortData, function(d) {
                        return d.values.length;
                    } )])
                    .rangeRound([hBar,0]);

            xScaleViolationBar = d3.scaleBand()
                        .rangeRound([0,wBar])
                        .padding(0,1)
                        .domain(sortData.map(function(d,i) {
                            return d.key;
                        }));
            
            //Create X axis
            svgHourBar.append("g")
                .attr("class", "axis-x")
                .attr("transform", "translate(" + (margin.left) + "," + (2*yDistanceFromHourChart+ hBar+margin.top+yPaddingForTitle) + ")")
                .call(d3.axisBottom(xScaleViolationBar));
            
            //Create Y axis
            svgHourBar.append("g")
                .attr("class", "axis-y-vio")
                .attr("transform", "translate(" + (margin.left) + "," + (2*yDistanceFromHourChart+margin.top+yPaddingForTitle) + ")")
                .call(d3.axisLeft(yScaleViolationBar));

            // Title label
            svgHourBar.append("text")
                        .attr("class", "barChartTitle")
                        .attr("x",  wBar/2 + 15)
                        .attr("y", 2*yDistanceFromHourChart+10)
                        .attr("dy", "1em")
                        .text("All districts");

            // X-Label
            svgHourBar.append("text")
                    .attr("class", "legendText")
                    .attr("transform",
                            "translate(" + ((wBar/2)+margin.left/2 - 15) + "," + 
                                        (2*yDistanceFromHourChart+hBar+35+margin.top+yPaddingForTitle) + ")")
                    .text("Type of violation");

            // Y-Label
            svgHourBar.append("text")
                .attr("class", "legendText")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - 5)
                .attr("x", 0 - 3*yDistanceFromHourChart + (hBar / 2) - yPaddingForTitle + 25) 
                .attr("dy", "1em")
                .text("# of violations"); 


            bars = svgHourBar.append("g")
                    .selectAll("rect1")
                    .data(sortData)
                    .enter()
                    .append("rect")
                    .attr("class", "vioData")
                    .attr("transform", "translate(" + (margin.left) + ","+ (2*yDistanceFromHourChart + margin.top) +")")
                    .attr("x", function(d,i) {
                        return xScaleViolationBar(d.key);
                    })
                    .attr("y", function(d) {                        
                        return yScaleViolationBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width", xScaleViolationBar.bandwidth()-1)
                    .attr("height", function(d){
                        return hBar-yScaleViolationBar(d.values.length);
                    })
                    .attr("fill", "darkkhaki")
                    .on("mouseover", function(d) {
                        d3.select(this)
                            .attr("fill", "khaki");

                        // Tooltip
                        div.transition()		
                            .duration(200)		
                            .style("opacity", .9);

                        div.html("<b>" + d.key + "</b></br>" + explainerTexts[d.key])	
                            .style("left", (d3.event.pageX) + "px")		
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        d3.select(this)
                            .attr("fill", "darkkhaki");

                        div.transition()		
                            .duration(500)		
                            .style("opacity", 0);
                    });
        }

        var yScaleFireTypeBar, xScaleFireTypeBar;
        var explainerTextsTypes = {
            'OUT': 'Outdoor fires in trash, rubbish, etc.',
            'COK': 'Cooking fire, contained to container',
            'OTH': 'Fire, other',
            'BUI': 'Building fire',
            'VEH': 'Vehicle fire, transport vehicle, passenger vehicle, etc.',
            'DUM': 'Dumpster or other outside trash receptacle fire',
            'NAT': 'Natural vegetation fire, e.g. grass, brush, other',
            'BOT': 'Building other - fire in struct. other than in a building, portable buildings, chimneys.',
            'EQU': 'Equipment fire',
        }

        function createFireTypeBarChart(data) {
            fireTypes = Object.keys(explainerTextsTypes)

            var tempData = [];
            for(var i = 0; i < data.length; i++) {
                if(data[i].type == 'incident') {
                    tempData.push(data[i].fireType);
                }
            }

            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempData);

            var descending = function (a, b) {
                return b.values.length - a.values.length
            }

            var sortData = filteredData.sort(descending);


            yScaleFireTypeBar = d3.scaleLinear()
                    .domain([0, d3.max(sortData, function(d) {
                        return d.values.length;
                    } )])
                    .rangeRound([hBar,0]);

            xScaleFireTypeBar = d3.scaleBand()
                        .rangeRound([0,wBar])
                        .padding(0,1)
                        .domain(sortData.map(function(d,i) {
                            return d.key;
                        }));

            //Create X axis
            svgHourBar.append("g")
                .attr("class", "axis-x")
                .attr("transform", "translate(" + (margin.left) + "," + (yDistanceFromHourChart+hBar+margin.top+yPaddingForTitle) + ")")
                .call(d3.axisBottom(xScaleFireTypeBar));
            
            //Create Y axis
            svgHourBar.append("g")
                .attr("class", "axis-y-type")
                .attr("transform", "translate(" + (margin.left) + "," + (yDistanceFromHourChart+margin.top+yPaddingForTitle) + ")")
                .call(d3.axisLeft(yScaleFireTypeBar));

            // Title label
            svgHourBar.append("text")
                        .attr("class", "barChartTitle")
                        .attr("x", wBar/2 + 15)
                        .attr("y", yDistanceFromHourChart + 10)
                        .attr("dy", "1em")
                        .text("All districts");

            // X-Label
            svgHourBar.append("text")
                    .attr("class", "legendText")
                    .attr("transform",
                            "translate(" + ((wBar/2)+margin.left/2) + "," + 
                                        (yDistanceFromHourChart+hBar+35+margin.top+yPaddingForTitle) + ")")
                    .text("Type of fire");

            // Y-Label
            svgHourBar.append("text")
                .attr("class", "legendText")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - 5)
                .attr("x", 0 - yDistanceFromHourChart - (hBar / 2) - 50 - yPaddingForTitle) 
                .attr("dy", "1em")
                .text("# of fires"); 


            bars = svgHourBar.append("g")
                    .selectAll("rect")
                    .data(sortData)
                    .enter()
                    .append("rect")
                    .attr("class", "typeData")
                    .attr("transform", "translate(" + (margin.left) + ","+ (yDistanceFromHourChart+margin.top) +")")
                    .attr("x", function(d,i) {
                        return xScaleFireTypeBar(d.key);
                    })
                    .attr("y", function(d) {                        
                        return yScaleFireTypeBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width", xScaleFireTypeBar.bandwidth()-1)
                    .attr("height", function(d){
                        return hBar-yScaleFireTypeBar(d.values.length);
                    })
                    .attr("fill", "darkorange")
                    .on("mouseover", function(d) {
                        d3.select(this)
                            .attr("fill", "orange");

                        // Tooltip
                        div.transition()		
                            .duration(200)		
                            .style("opacity", .9);

                        div.html("Incidents: " + d.values.length + "</br>" + explainerTextsTypes[d.key])
                            .style("left", (d3.event.pageX) + "px")		
                            .style("top", (d3.event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        d3.select(this)
                            .attr("fill", "darkorange");

                        div.transition()		
                            .duration(500)		
                            .style("opacity", 0);
                    });
        }


        var paddingLeft = 30;
        var titlePadding = 50;
        // set the ranges
        var x = d3.scaleTime().range([0, w-100]);
        var y = d3.scaleLinear().range([hBar*2, 0]);

        var x2 = d3.scaleTime().range([0, w-100]);
        var y2 = d3.scaleLinear().range([hBar/3, 0]);

        // Axes
        var xAxis = d3.axisBottom(x);

        // define the line
        var valueline = d3.line()
                            .x(function(d) { return x( d.key); })
                            .y(function(d) { 
                                return y(d.values.length); });

        var clip = svgLineChart.append("defs").append("svg:clipPath")
                                .attr("id", "clip")
                                .append("svg:rect")
                                .attr("width", w - 100)
                                .attr("height", hBar*1.5 + yPaddingForTitle + 100)
                                .attr("x", 0)
                                .attr("y", -10); 

        var brushTime = d3.brushX()
                              .extent([[0,0], [w-100, hBar/3]])
                              .on("brush", brushedTime);

        function createLineChart(data) {

            var tempIncidents = [];
            var tempViolations = [];
            for(var i = 0; i < data.length; i++) {
                if(data[i].type == 'violation') {
                    tempViolations.push(data[i]);
                } else {
                    tempIncidents.push(data[i]);
                }
            }
            
            var filteredIncidents = d3.nest()
                .key(function(d) {
                    return convertToDates(d.date);
                })
                .entries(tempIncidents);

            var filteredViolations = d3.nest()
                .key(function(d) {
                    return convertToDates(d.date);
                })
                .entries(tempViolations);            


            dates = {}

            var sortIncidents = filteredIncidents;
            sortIncidents.forEach(function(d) {
                d.key = new Date(d.key);

                dates[d.key] = d.values;
            })

            var allData = [];
            var allDates = getDates(new Date("1/3/2005"), new Date("4/20/2018"))
            allDates.forEach(d => {
                d = new Date(d.key);
                if (dates[d] != undefined) {
                    allData.push({
                        key: d,
                        values: dates[d]
                    })
                } else {
                    allData.push({
                        key: d,
                        values: []
                    })
                }
            })

            sortIncidents = allData;
            sortIncidents.sort(function(a,b){
                // Turn your strings into dates, and then subtract them
                // to get a value that is either negative, positive, or zero.
                return new Date(b.key) - new Date(a.key);
            });


            dates = {}
            var sortViolations = filteredViolations;
            sortViolations.forEach(function(d) {
                d.key = new Date(d.key);

                dates[d.key] = d.values;
            })
            
            allData = [];
            allDates.forEach(d => {
                d = new Date(d.key);
                if (dates[d] != undefined) {
                    allData.push({
                        key: d,
                        values: dates[d]
                    })
                } else {
                    allData.push({
                        key: d,
                        values: []
                    })
                }
            })

            sortViolations = allData;
 
            sortViolations.sort(function(a,b){
                // Turn your strings into dates, and then subtract them
                // to get a value that is either negative, positive, or zero.
                return new Date(b.key) - new Date(a.key);
            });

            x.domain(d3.extent(sortViolations, function(d) { 
                return d.key; }));
            y.domain([0, d3.max(sortViolations, function(d) {
                return d.values.length; })]);
            
            x2.domain(x.domain());
            y2.domain(y.domain());

            svgLineChart.append("path")
                .data([sortViolations])
                .attr("class", "lineDataViolations")
                .attr("stroke", "teal")
                .attr("transform", "translate(" + (margin.left+paddingLeft) + ","+titlePadding +")")
                .attr("clip-path", "url(#clip)")
                .attr("d", valueline)
                .style("opacity", 1);

            svgLineChart.append("path")
                .data([sortIncidents])
                .attr("class", "lineDataIncidents")
                .attr("stroke", "red")
                .attr("transform", "translate(" + (margin.left+paddingLeft) + ","+titlePadding +")")
                .attr("clip-path", "url(#clip)")
                .attr("d", valueline)
                .style("opacity", 1);
                

            var violationSpikes = [];
            sortViolations.forEach(d => {
                var numberOfViolations = d.values.length;
                var date = d.key;
                var month = date.getMonth() + 1;
                
                if (numberOfViolations >= 62 && (month == 1 || month == 9 || month == 11) ) {
                    var vd = {}
                    d.values.forEach(dd => {
                        vd[dd.violation] = (vd[dd.violation] == undefined) ? 0 : vd[dd.violation] + 1;
                    })

                    console.log(vd)
                    // Create items array
                    var items = Object.keys(vd).map(function(key) {
                        return [key, vd[key]];
                    });

                    // Sort the array based on the second element
                    items.sort(function(first, second) {
                        return second[1] - first[1];
                    });

                    // Create a new array with only the first 5 items
                    var top5 = items.slice(0, 5);

                    var s = ""
                    top5.forEach(d => {
                        s += "Violation type: " + d[0] + ", Occurences: " + d[1] + "</br>Description: " + explainerTexts[d[0]] + "</br></br>"
                    })

                    var item = {
                        key: date,
                        values: d.values,
                        s: s
                    };

                    violationSpikes.push(item);
                }
            })

            svgLineChart.selectAll("dot")
                        .data(violationSpikes)
                        .enter()
                        .append("circle")
                        .attr("class", "dot")
                        .attr("cx", function(d) {
                            return x(d.key) + 80;
                        })
                        .attr("cy", function(d) {
                            return y(d.values.length) + 50
                        })
                        .attr("r", 3)
                        .style("fill", "white")
                        .style("stroke", "teal")
                        .style("stroke-width", 1)
                        .style("cursor", "pointer")
                        .style("opacity", 1)
                        .on("mouseover", function(d) {
                            if (d3.select(this).style("opacity") > 0.5) {
                                div.transition()		
                                    .duration(200)		
                                    .style("opacity", .9);

                                div.html(d.s)	
                                    .style("left", (d3.event.pageX) + "px")		
                                    .style("top", (d3.event.pageY - 28) + "px");
                            }
                        })
                        .on("mouseout", function(d) {
                            div.transition()		
                                .duration(500)		
                                .style("opacity", 0);
                        });

            // Add the X Axis
            svgLineChart.append("g")
                .attr("class","x-axis-line")
                .attr("transform", "translate("+(margin.left+paddingLeft) + "," + (2*hBar+titlePadding) + ")")
                .call(xAxis);

            // Add the time X Axis
            svgLineChart.append("g")
                        .attr("class", "x-axis-line-time")
                        .attr("transform", "translate("+(margin.left+paddingLeft) + "," + (2.85*hBar+titlePadding) + ")")
                        .call(d3.axisBottom(x2));

            // Timeline brush
            svgLineChart.append("g")
                        .attr("class", "brushTime")
                        .attr("transform", "translate("+(margin.left+paddingLeft) + "," + (3*hBar - 24) + ")")
                        .call(brushTime)
                        .call(brushTime.move, x.range());

            // Add the Y Axis
            svgLineChart.append("g")
                .attr("class", "y-axis-line")
                .attr("transform", "translate(" + (margin.left+paddingLeft) + "," + titlePadding +")")
                .call(d3.axisLeft(y));

            // Title label
            svgLineChart.append("text")
                .attr("class", "barChartTitle")
                .attr("x", w/2 - 100)
                .attr("y",  -5)
                .attr("dy", "1em")
                .text("Violations and Incidents over time");

            // Subtitle label
            svgLineChart.append("text")
                .attr("class", "barChartTitle")
                .attr("x", w/2 - 200)
                .attr("y",  15)
                .attr("dy", "1em")
                .style("font-size", "12px")
                .style("fill", "darkgray")
                .text("Click the legend to hide/show incidents or violations. Zoom in on the data using the brush below.");

            // X-Label
            svgLineChart.append("text")
                .attr("class", "legendText")
                .attr("x", w/2)
                .attr("y",  2*hBar + 50+titlePadding - 20)
                .text("Date");

            // Y-Label
            svgLineChart.append("text")
                .attr("class", "legendText")
                .attr("transform", "rotate(-90)")
                .attr("y", 5)
                .attr("x", 0 - (hBar / 2) -130) 
                .attr("dy", "1em")
                .text("# of violations and incidents"); 

            // Legend
            var names = ["Incidents","Violations" ];
            var padding = 20;

            svgLineChart.append("text")
                .attr("x", margin.left+80)
                .attr("y", 10+titlePadding)
                .on("click", function() {
                    var currentOp = svgLineChart.select("path.lineDataIncidents").style("opacity");
                    if (currentOp == 1) {
                        svgLineChart.select("path.lineDataIncidents").style("opacity", 0);
                        svgLineChart.select("circle.legendI").attr("fill", "gray");
                    } else {
                        svgLineChart.select("path.lineDataIncidents").style("opacity", 1);
                        svgLineChart.select("circle.legendI").attr("fill", "red");
                    }
                })
                .style("cursor", "pointer")
                .text(function(d) {
                    return names[0];
                });

            svgLineChart.append("text")
                .attr("x", margin.left+80)
                .attr("y", 30+titlePadding)
                .on("click", function() {
                    var currentOp = svgLineChart.select("path.lineDataViolations").style("opacity");
                    if (currentOp == 1) {
                        svgLineChart.select("path.lineDataViolations").style("opacity", 0);
                        svgLineChart.selectAll("circle.dot").style("opacity", 0);
                        svgLineChart.select("circle.legendV").attr("fill", "gray");
                    } else {
                        svgLineChart.select("path.lineDataViolations").style("opacity", 1);
                        svgLineChart.selectAll("circle.dot").style("opacity", 1);
                        svgLineChart.select("circle.legendV").attr("fill", "teal");
                    }
                })
                .style("cursor", "pointer")
                .text(function(d) {
                    return names[1];
                });

            svgLineChart.append("circle")
                .attr("class", "legendI")
                .attr("cx", margin.left+70)
                .attr("cy", 5+titlePadding)
                .attr("r", 5)
                .attr("fill", "red");
            
            svgLineChart.append("circle")
                .attr("class", "legendV")
                .attr("cx", margin.left+70)
                .attr("cy", 25+titlePadding)
                .attr("r", 5)
                .attr("fill", "teal");

            }


        Date.prototype.addDays = function(days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
            return date;
        }

        function getDates(startDate, stopDate) {
            var dateArray = new Array();
            var currentDate = startDate;
            while (currentDate <= stopDate) {
                d = {
                    key: new Date (currentDate),
                    values: []
                }
                dateArray.push(d);
                currentDate = currentDate.addDays(1);
            }
            return dateArray;
        }

        function brushedTime() {
            if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom") return; // ignore brush-by-zoom
            var s = d3.event.selection || x2.range();
            x.domain(s.map(x2.invert, x2));
            svgLineChart.select("path.lineDataIncidents").attr("d", valueline);
            svgLineChart.select("path.lineDataViolations").attr("d", valueline);
            svgLineChart.select("g.x-axis-line").call(xAxis);

            svgLineChart.selectAll("circle.dot")
                        .attr("cx", function(d) {
                            return x(d.key) + 80;
                        })
                        .style("opacity", function(d) {
                            if (x(d.key) < 1) {
                                return 0;
                            } else {
                                return 1;
                            }
                        });
        }

        function brushed() {
            if (d3.event.selection != null) {
                // revert circles to initial style
                circles.attr("class", "non_brushed");

                var brush_coords = d3.brushSelection(this);

                // var districtNames = Object.keys(circleDict);
                // districtNames.forEach(d => {
                //     let circleData = circleDict[d];
                //     let districtClass = "district" + d.replace(/\s/g, '').replace(/\//g, '');

                //     circleData.filter(function (){
                //         var cx = d3.select(this).attr("cx"),
                //             cy = d3.select(this).attr("cy");
                //         return isBrushed(brush_coords, cx, cy);
                //     })
                //     .attr("class", "brushed");
                // })
                // style brushed circles
                circles.filter(function (){
                        var cx = d3.select(this).attr("cx"),
                            cy = d3.select(this).attr("cy");
                        return isBrushed(brush_coords, cx, cy);
                })
                .attr("class", "brushed");

                var d_brushed =  d3.selectAll(".brushed").data();
                if (d_brushed.length > 0) {
                    // clearChart();
                    // createBarChart(d_brushed);
                    updateHourBarChartValues(d_brushed);
                    updateViolationTypeBarChartValues(d_brushed);
                    updateFireTypeBarChartValues(d_brushed);
                    updateLineChartValues(d_brushed);
                } else {
                    // clearChart();
                    updateHourBarChartValues(d_brushed);
                    updateViolationTypeBarChartValues(d_brushed);
                    updateFireTypeBarChartValues(d_brushed);
                    updateLineChartValues(d_brushed);
                }
            }
        }

        function isBrushed(brush_coords, cx, cy) {
            var x0 = brush_coords[0][0],
                x1 = brush_coords[1][0],
                y0 = brush_coords[0][1],
                y1 = brush_coords[1][1];

            return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;
        }

        function updateFireTypeBarChartValues(data) {
            var tempData = [];
            for(var i = 0; i < data.length; i++) {
                if(data[i].type == 'incident') {
                    tempData.push(data[i].fireType);
                }
            }

            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempData);

            var descending = function (a, b) {
                return b.values.length - a.values.length
            }

            var sortData = filteredData.sort(descending);

            var dataKeys = [];
            sortData.forEach(d => {
                dataKeys.push(d.key)
            })

            var data = [];
            fireTypes.forEach(d => {
                if (dataKeys.includes(d)) {
                    sortData.forEach(o => {
                        if (o.key == d) {
                            data.push(o);
                        }
                    })
                } else {
                    data.push({
                        key: d,
                        values: []
                    })
                }
            })

            sortData = data;

            yScaleFireTypeBar = d3.scaleLinear()
                    .domain([0, d3.max(sortData, function(d) {
                        return d.values.length;
                    } )])
                    .rangeRound([hBar,0]);

            
            svgHourBar.selectAll("g.axis-y-type")
                .call(d3.axisLeft(yScaleFireTypeBar));

            svgHourBar.selectAll("rect.typeData")
                    .data(sortData)
                    .transition()
                    .duration(250)
                    .ease(d3.easeLinear)
                    .attr("class","typeData")
                    .attr("transform", "translate(" + (margin.left) + ","+ (yDistanceFromHourChart+ margin.top) +")")
                    .attr("x",function(d,i) {
                        return xScaleFireTypeBar(d.key);
                    })
                    .attr("y",function(d) {                    
                        return yScaleFireTypeBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width", xScaleFireTypeBar.bandwidth()-1)
                    .attr("height",function(d){
                        return hBar-yScaleFireTypeBar(d.values.length);
                    });
        }

        function updateViolationTypeBarChartValues(newValues) {
            var tempHourData = [];
            for(var i = 0; i < newValues.length; i++) {
                //Bar chart is only for incidents, not violations. 
                if(newValues[i].type == 'violation') {
                    tempHourData.push(newValues[i].violation);
                }
            }

            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempHourData);

            var descending = function (a, b) {
                return b.values.length - a.values.length
            }

            var sortData = filteredData.sort(descending);

            var dataKeys = [];
            sortData.forEach(d => {
                dataKeys.push(d.key)
            })

            var data = [];
            violationTypes.forEach(d => {
                if (dataKeys.includes(d)) {
                    sortData.forEach(o => {
                        if (o.key == d) {
                            data.push(o);
                        }
                    })
                } else {
                    data.push({
                        key: d,
                        values: []
                    })
                }
            })

            sortData = data;

            yScaleViolationBar = d3.scaleLinear()
                                    .domain([0, d3.max(sortData, function(d) {
                                        return d.values.length;
                                    } )])
                                    .rangeRound([hBar,0]);

            svgHourBar.selectAll("g.axis-y-vio")
                    .call(d3.axisLeft(yScaleViolationBar));

            svgHourBar.selectAll("rect.vioData")
                    .data(sortData)
                    .transition()
                    .duration(250)
                    .ease(d3.easeLinear)
                    .attr("class","vioData")
                    .attr("transform", "translate(" + (margin.left) + ","+ (2*yDistanceFromHourChart +margin.top) +")")
                    .attr("x",function(d,i) {
                        return xScaleViolationBar(d.key);
                    })
                    .attr("y",function(d) {                    
                        return yScaleViolationBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width",xScaleViolationBar.bandwidth()-1)
                    .attr("height",function(d){
                        return hBar-yScaleViolationBar(d.values.length);
                    });
        }

        function updateHourBarChartValues(newValues) {
            var tempHourData = [];
            for(var i = 0; i < newValues.length; i++) {
                //Bar chart is only for incidents, not violations. 
                if(newValues[i].type == 'incident') {
                    tempHourData.push(newValues[i].hour);
                }
            }

            var filteredData = d3.nest()
                                .key(function(d) {
                                    return d;
                                })
                                .entries(tempHourData);

            var ascending = function (a, b) {
                return a.key - b.key
            }

            var sortData = filteredData.sort(ascending);

            var data = [];
            for(var i = 0; i < hoursLabels.length; i++) {
                data.push({
                    'hour': "" + (i),
                    'values': []
                })
            }

            // console.log(data)

            sortData.forEach( d => {
                var index = d.key;
                data[index] = d;
            })

            // console.log(sortData)

            sortData = data;

            yScaleBar = d3.scaleLinear()
                    .domain([0, d3.max(sortData, function(d) {
                        return d.values.length;
                    } )])
                    .rangeRound([hBar,0]);

            svgHourBar.selectAll("g.axis-y")
                    .call(d3.axisLeft(yScaleBar));

            svgHourBar.selectAll("rect.selData")
                    .data(sortData)
                    .transition()
                    .duration(250)
                    .ease(d3.easeLinear)
                    .attr("class","selData")
                    .attr("transform","translate(" + margin.left + ","+ margin.top +")")
                    .attr("x",function(d,i) {
                        return xScaleBar(+d.key);
                    })
                    .attr("y",function(d) {                    
                        return yScaleBar(d.values.length) + yPaddingForTitle;
                    })
                    .attr("width",xScaleBar.bandwidth()-1)
                    .attr("height",function(d){
                        return hBar-yScaleBar(d.values.length);
                    });
        }

        function updateLineChartValues(data) {
            var tempIncidents = [];
            var tempViolations = [];
            for(var i = 0; i < data.length; i++) {
                if(data[i].type == 'violation') {
                    tempViolations.push(data[i]);
                } else {
                    tempIncidents.push(data[i]);
                }
            }
            
            var filteredIncidents = d3.nest()
                .key(function(d) {
                    return convertToDates(d.date);
                })
                .entries(tempIncidents);

            var filteredViolations = d3.nest()
                .key(function(d) {
                    return convertToDates(d.date);
                })
                .entries(tempViolations);

            

            var sortIncidents = filteredIncidents;
            sortIncidents.forEach(function(d) {
                d.key = new Date(d.key);
            })

             sortIncidents.sort(function(a,b){
                // Turn your strings into dates, and then subtract them
                // to get a value that is either negative, positive, or zero.
                return new Date(b.key) - new Date(a.key);
            });

            var sortViolations = filteredViolations;
            sortViolations.forEach(function(d) {
                d.key = new Date(d.key);
            })
            
 
            sortViolations.sort(function(a,b){
                // Turn your strings into dates, and then subtract them
                // to get a value that is either negative, positive, or zero.
                return new Date(b.key) - new Date(a.key);
            });

            x.domain(d3.extent(sortViolations, function(d) { 
                return d.key; }));
            y.domain([0, d3.max(sortViolations, function(d) {
                return d.values.length; })]);


            svgLineChart.selectAll("g.axis-y-line")
                    .call(d3.axisLeft(y));

            svgLineChart.selectAll("g.axis-x-line")
                    .call(d3.axisBottom(x));

            svgLineChart.selectAll("path.lineDataIncidents")
                    .data([sortIncidents])
                    .transition()
                    .duration(250)
                    .ease(d3.easeLinear)
                    .attr("class","lineDataIncidents")
                    .attr("transform", "translate(" + (margin.left+paddingLeft) + ","+titlePadding +")")
                    .attr("d", valueline);

            svgLineChart.selectAll("path.lineDataViolations")
                    .data([sortViolations])
                    .transition()
                    .duration(250)
                    .ease(d3.easeLinear)
                    .attr("class","lineDataViolations")
                    .attr("transform", "translate(" + (margin.left+paddingLeft) + ","+titlePadding +")")
                    .attr("d", valueline);

        }

    </script>  
  </body>
</html>